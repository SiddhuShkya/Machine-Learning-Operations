# Name of the GitHub Actions workflow (visible in the Actions tab)
name: CI/CD for dockerized Flask App

# Events that trigger this workflow
on:
    # Run the workflow on push events to the main branch
    push:
        branches: [ main ]
    # Run the workflow on pull requests targeting the main branch
    pull_request:
        branches: [ main ]

# Define all jobs in the workflow
jobs:
    # ---------------- CI JOB ----------------
    # This job builds the app and runs unit tests
    build-and-test: 
        # Use the latest Ubuntu runner
        runs-on: ubuntu-latest

        steps:
        # Step 1: Checkout the repository code
        - name: Checkout code
          uses: actions/checkout@v3

        # Step 2: Set up the Python environment
        - name: Set up Python
          uses: actions/setup-python@v4
          with:
              python-version: '3.10'

        # Step 3: Install project dependencies
        - name: Install dependencies
          run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

        # Step 4: Run unit tests using pytest
        - name: Run tests
          run: |
              pytest

    # ---------------- CD JOB ----------------
    # This job builds and pushes the Docker image to Docker Hub
    build-and-publish:
        # Run this job only if build-and-test succeeds
        needs: build-and-test
        runs-on: ubuntu-latest

        steps:
        # Step 1: Checkout the repository code
        - name: Checkout code
          uses: actions/checkout@v3

        # Step 2: Set up Docker Buildx for advanced Docker builds
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2

        # Step 3: Authenticate with Docker Hub using GitHub Secrets
        - name: Log in to Docker Hub
          uses: docker/login-action@v2
          with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}

        # Step 4: Build the Docker image and push it to Docker Hub
        - name: Build and push Docker image
          uses: docker/build-push-action@v4
          with:
              context: .
              file: ./Dockerfile
              push: true
              tags: ${{ secrets.DOCKER_USERNAME }}/flask-test-app:latest
        
        # Step 5: Output the image digest for verification/debugging
        - name: Image digest
          run: echo ${{ steps.build-and-publish.outputs.digest }}
